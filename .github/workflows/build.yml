name: Build OpenWrt

on:
  workflow_dispatch:
    inputs:
      repo_branch:
        description: 'OpenWrt Source Branch'
        required: true
        default: 'v25.12.0-rc2'
      config_file:
        description: 'Config File Name (in config/)'
        required: true
        default: 'r4s.config'
      cache_toolchain:
        description: 'Enable Toolchain Cache'
        required: false
        default: 'true'
        type: boolean

      ssh_sync:
        description: 'å¼€å¯ VPS ç§äººåŒæ­¥'
        type: boolean
        required: false
        default: false
      vps_host:
        description: 'VPS åœ°å€ ( å¿…é¡»IPv4åœ°å€/åŸŸå )'
        required: false
        default: 'amd.899957.xyz'
      vps_user:
        description: 'VPS ç”¨æˆ·å'
        required: false
        default: 'root'
      remote_path:
        description: 'VPS è¿œç¨‹ç›®å½•'
        required: false
        default: '/root/openwrt'

env:
  REPO_URL: https://git.openwrt.org/openwrt/openwrt.git
  # ä» input è¯»å–ï¼Œå¦‚æœæ‰‹åŠ¨è§¦å‘æœªæŒ‡å®šåˆ™ä½¿ç”¨ default
  REPO_BRANCH: ${{ inputs.repo_branch }}
  CONFIG_FILE: config/${{ inputs.config_file }}
  CUSTOM_PKG_DIR: new
  CUSTOM_FILES_DIR: files
  REPO_LIST_FILE: repos.list
  TZ: Asia/Shanghai

jobs:
  build:
    runs-on: ubuntu-24.04
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: Print hardware info
      run: |
        echo "=== OS ==="
        cat /etc/os-release || true
        uname -a
        echo "=== CPU ==="
        lscpu
        echo "=== Memory ==="
        free -h
        echo "=== CPU details (proc) ==="
        head -n 20 /proc/cpuinfo          

    - name: Optimize Disk Space
      uses: hugoalh/disk-space-optimizer-ghaction@v0.8.1
      with:
        operate_sudo: "True"
        general_include: ".+"
        general_exclude: |-
          ^GCC$
          ^G\+\+$
          Clang
          LLVM
        docker_prune: "True"
        docker_clean: "True"
        apt_prune: "True"
        apt_clean: "True"
        homebrew_prune: "True"
        homebrew_clean: "True"
        npm_prune: "True"
        npm_clean: "True"
        os_swap: "True"

    - name: Setup Go Environment
      uses: actions/setup-go@v5
      with:
        go-version: '1.22'
        check-latest: true
        cache: false 

    - name: Initialization Environment
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo bash -c 'bash <(curl -s https://build-scripts.immortalwrt.org/init_build_environment.sh)'
        sudo -E apt-get -qq install dwarves
        sudo timedatectl set-timezone "$TZ"
        sudo chown $USER:$GROUPS $GITHUB_WORKSPACE
        
    - name: Clone Source Code
      run: |
        echo "Cloning branch: ${{ env.REPO_BRANCH }}"
        git clone --depth 1 --branch ${{ env.REPO_BRANCH }} $REPO_URL openwrt        

    # =======================================================
    #  ç§äºº VPS åŒæ­¥ (SSH Key ç‰ˆ)
    # =======================================================
    - name: Sync Private Config via SSH
      if: inputs.ssh_sync == true
      env:
        SSH_KEY: ${{ secrets.VPS_PRIVATE_KEY }}  # è¯»å– Secret
        VPS_HOST: ${{ inputs.vps_host }}
        VPS_USER: ${{ inputs.vps_user }}
        REMOTE_PATH: ${{ inputs.remote_path }}
      run: |
        echo "=== å¼€å§‹ç§äººå®šåˆ¶åŒæ­¥ ==="
        
        # 1. é…ç½® SSH Key
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H $VPS_HOST >> ~/.ssh/known_hosts
        SSH_OPTS="-i ~/.ssh/id_rsa -o BatchMode=yes -o ConnectTimeout=10"
        
        # 2. åŒæ­¥ files ç›®å½•
        # å°† VPS ä¸Šçš„ files ç›®å½•å†…å®¹ï¼Œåˆå¹¶åˆ°å½“å‰å·¥ä½œåŒºçš„ files ç›®å½•
        # æ³¨æ„: è¿œç¨‹è·¯å¾„æœ«å°¾åŠ æ–œæ è¡¨ç¤ºåŒæ­¥ç›®å½•
        echo "æ­£åœ¨ä» VPS åŒæ­¥ files ç›®å½•..."
        mkdir -p files
        mkdir -p etc
        mkdir -p root

        ssh $SSH_OPTS $VPS_USER@$VPS_HOST "bash $REMOTE_PATH/rsync.sh > /dev/null"
        echo "[OK] remote script done"
        rsync -az --quiet -e "ssh $SSH_OPTS" \
          $VPS_USER@$VPS_HOST:$REMOTE_PATH/files/ files/
        echo "[OK] rsync done"
        
        echo " ğŸ›» files ç›®å½•åŒæ­¥å®Œæˆï¼Œå½“å‰ content:"
        ls -F files/
        ls -F files/etc/
        ls -F files/root/
        # -------------------------------------------------------
        # 3. åŒæ­¥ new æºç ç›®å½• (è¦†ç›–/åˆå¹¶)
        # -------------------------------------------------------
        echo "æ­£åœ¨ä» VPS åŒæ­¥ new æºç ç›®å½•..."
        mkdir -p new
        # å°† VPS ä¸Šçš„ new ç›®å½•ä¸‹çš„æ‰€æœ‰æ’ä»¶æ–‡ä»¶å¤¹ï¼ŒåŒæ­¥åˆ°æœ¬åœ° new ç›®å½•
        rsync -avz -e "ssh $SSH_OPTS" \
          $VPS_USER@$VPS_HOST:$REMOTE_PATH/new/ new/
          
        echo "å½“å‰ new ç›®å½•ç»“æ„ï¼š"
        ls -F new/        
        cp new/99-r4s.sh files/etc/uci-defaults/
        ls -F files/etc/uci-defaults/
        # 4. è¿½åŠ  custom.config
        # è¯»å– VPS ä¸Šçš„ private.configï¼Œè¿½åŠ åˆ°æœ¬åœ° custom.config
        echo "æ­£åœ¨è¿½åŠ ç§æœ‰é…ç½®åˆ° custom.config..."        
        # ç¡®ä¿æœ¬åœ°æ–‡ä»¶å­˜åœ¨
        touch custom.config
        echo "" >> custom.config # ç¡®ä¿æ¢è¡Œ
        ssh $SSH_OPTS $VPS_USER@$VPS_HOST "cat $REMOTE_PATH/private.config" >> custom.config
        
        echo "é…ç½®è¿½åŠ å®Œæˆï¼Œæœ€åå‡ è¡Œå¦‚ä¸‹ï¼š"
        tail -n 10 custom.config
        
        # æ¸…ç† Key (è™½ç„¶ Action ç»“æŸä¼šé”€æ¯ç¯å¢ƒï¼Œä½†å…»æˆå¥½ä¹ æƒ¯)
        rm -f ~/.ssh/id_rsa
    # =======================================================
    # æ™ºèƒ½è®¡ç®—ç¼“å­˜ä¿¡æ¯
    # =======================================================
    - name: Get Cache Infos
      if: inputs.cache_toolchain == true
      run: |
        # æŒ‡å®šä½ çš„ config æ–‡ä»¶è·¯å¾„
        MY_CONFIG_PATH="$GITHUB_WORKSPACE/${{ env.CONFIG_FILE }}"
        echo "Reading architecture info from $MY_CONFIG_PATH"
        
        # æå– Target (å¦‚ rockchip)
        # é€»è¾‘ï¼šæŸ¥æ‰¾ CONFIG_TARGET_BOARD="xxx"ï¼Œæå–å¼•å·å†…çš„å†…å®¹
        TARGET=$(grep "^CONFIG_TARGET_BOARD" "$MY_CONFIG_PATH" | awk -F '"' '{print $2}')
        [ -z "$TARGET" ] && TARGET="unknown"
        
        # æå– Subtarget (å¦‚ armv8)
        SUBTARGET=$(grep "^CONFIG_TARGET_SUBTARGET" "$MY_CONFIG_PATH" | awk -F '"' '{print $2}')
        [ -z "$SUBTARGET" ] && SUBTARGET="unknown"
        
        echo "Detected Architecture: $TARGET - $SUBTARGET"
        
        # å†™å…¥ç¯å¢ƒå˜é‡
        echo "DEVICE_TARGET=$TARGET" >> $GITHUB_ENV
        echo "DEVICE_SUBTARGET=$SUBTARGET" >> $GITHUB_ENV

    # å¯ç”¨ Toolchain ç¼“å­˜
    - name: Cache Toolchain
      if: inputs.cache_toolchain == true
      uses: HiGarfield/cachewrtbuild@main
      with:
        ccache: false # å¿…é¡»ä¸º falseï¼Œåªç¼“å­˜å·¥å…·é“¾ä»¥èŠ‚çœç©ºé—´
        # Key: æºç åˆ†æ”¯-æ¶æ„-å­æ¶æ„ (ä¸åŒé…ç½®åªè¦æ¶æ„ç›¸åŒå°±èƒ½å…±ç”¨ç¼“å­˜)
        mixkey: ${{ env.REPO_BRANCH }}-${{ env.DEVICE_TARGET }}-${{ env.DEVICE_SUBTARGET }}
        prefix: 'openwrt'

    - name: Update & Install Feeds
      working-directory: ./openwrt
      run: |
        rm -rf package/boot/rkbin
        rm -rf package/boot/uboot-rockchip
        rm -rf package/boot/arm-trusted-firmware-rockchip
        
        git clone https://github.com/immortalwrt/immortalwrt.git /tmp/immortalwrt --depth 1 -b v24.10.4
        cp -r /tmp/immortalwrt/package/boot/uboot-rockchip package/boot/
        cp -r /tmp/immortalwrt/package/boot/arm-trusted-firmware-rockchip package/boot/
        #git clone https://github.com/sbwml/package_boot_uboot-rockchip package/boot/uboot-rockchip -b v2023.04
        #git clone https://github.com/sbwml/arm-trusted-firmware-rockchip package/boot/arm-trusted-firmware-rockchip -b 0419

        ./scripts/feeds update -a
        ./scripts/feeds install -a
        # 4. ä¿®å¤ Rust ç¼–è¯‘æŠ¥é”™ (å¿…é¡»åŠ åœ¨ install ä¹‹å)
        sed -i 's/download-ci-llvm = true/download-ci-llvm = "if-unchanged"/g' feeds/packages/lang/rust/Makefile
        # å¦‚æœä½ éœ€è¦ä¼ªé€ å†…æ ¸æŒ‡çº¹ï¼Œè¯·åœ¨è¿™é‡Œæ’å…¥
        # Vermagic ------------------
        #latest_version="$(curl -s https://github.com/openwrt/openwrt/tags | grep -Eo "v[0-9\.]+\-*r*c*[0-9]*.tar.gz" | sed -n '/[2-9][5-9]/p' | sed -n 1p | sed 's/v//g' | sed 's/.tar.gz//g')"
        #wget https://downloads.openwrt.org/releases/${latest_version}/targets/rockchip/armv8/profiles.json
        #jq -r '.linux_kernel.vermagic' profiles.json >.vermagic
        #sed -i -e 's/^\(.\).*vermagic$/\1cp $(TOPDIR)\/.vermagic $(LINUX_DIR)\/.vermagic/' include/kernel-defaults.mk
    # ------------------------------------------------ 
    # å¤„ç† Custom
    - name: Load Custom Configuration & Plugins
      run: |
        mkdir -p openwrt/package/custom_repos
        touch auto_packages.txt

        # ğŸ”´ å®šä¹‰æŠ“å–å‡½æ•° (æ”¯æŒç¨€ç–æ£€å‡º + Makefile ä¿®å¤ + è‡ªåŠ¨è®°å½•)
        function git_sparse_clone() {
          branch="$1" rurl="$2" localdir="$3" && shift 3
          # è§£æ URL
          git_repo_url=$(echo $rurl | sed -E "s|/tree/.*||")
          subdir=$(echo $rurl | sed -E "s|.*/tree/$branch/||")
          pkg_name=$(basename $subdir)
          
          echo "Processing: $pkg_name from $subdir"
          
          # ä¸´æ—¶ç›®å½•å¤„ç†
          tmpdir="tmp_checkout_$(date +%s%N)"
          git clone --depth 1 --filter=blob:none --sparse $git_repo_url $tmpdir
          cd $tmpdir
          git sparse-checkout set $subdir
          git checkout $branch
          
          # ç§»åŠ¨åˆ° openwrt/package/custom_repos/
          target_path="../openwrt/package/custom_repos/$pkg_name"
          if [ -d "$target_path" ]; then rm -rf "$target_path"; fi
          mv $subdir $target_path
          cd ..
          rm -rf $tmpdir
        }
          
        # â¬‡ï¸ğŸ“ 1. å¤„ç† repos.list
        echo "  â˜ï¸ Git clone repos.lit..."
        if [ -f "$GITHUB_WORKSPACE/$REPO_LIST_FILE" ]; then
          echo "Reading $REPO_LIST_FILE..."
          while IFS= read -r url || [ -n "$url" ]; do
             [[ -z "$url" || "$url" =~ ^# ]] && continue
             if [[ "$url" == *"tree/master"* || "$url" == *"tree/main"* ]]; then
                 if [[ "$url" == *"tree/master"* ]]; then branch="master"; else branch="main"; fi
                 git_sparse_clone $branch "$url" "openwrt/package/custom_repos"
             else
                 # æ™®é€šä»“åº“ clone
                 echo "Cloning standard repo: $url"
                 cd openwrt/package/custom_repos
                 git clone --depth 1 "$url"
                 cd ../../../
             fi
          done < "$GITHUB_WORKSPACE/$REPO_LIST_FILE"
        fi
        
        # ğŸ“‚ 2. å¤„ç†æœ¬åœ° new ç›®å½• (æ‰‹åŠ¨ç»´æŠ¤çš„æ’ä»¶)
        if [ -d "$GITHUB_WORKSPACE/$CUSTOM_PKG_DIR" ]; then
          echo "  ğŸ“‚ Copying local custom packages...new"
          cp -r $GITHUB_WORKSPACE/$CUSTOM_PKG_DIR/* openwrt/package/custom_repos/ || true
        fi

        echo "  ğŸ˜‹ æ£€æŸ¥packageç›®å½•ä¸‹çš„è‡ªå®šä¹‰æ’ä»¶ä»“åº“" 
        ls -lh openwrt/package/custom_repos
        
        # ğŸ”´ 3. Makefile è·¯å¾„è‡ªåŠ¨ä¿®å¤
        echo "Applying global patches to custom packages..."
        # æŸ¥æ‰¾æ‰€æœ‰å« Makefile çš„ç›®å½• (æ’é™¤ src ç›®å½•)
        find openwrt/package/custom_repos -name Makefile | while read makefile; do
            # A. ä¿®å¤ Go è·¯å¾„ (../../lang/golang -> $(TOPDIR)/feeds/packages/lang/golang)
            if grep -q "\.\./\.\./lang/golang/golang-package.mk" "$makefile"; then
                echo "Fixing Go path in: $makefile"
                sed -i 's|\.\./\.\./lang/golang/golang-package.mk|$(TOPDIR)/feeds/packages/lang/golang/golang-package.mk|g' "$makefile"
            fi
            
            # B. ä¿®å¤ Rust è·¯å¾„ (../../lang/rust -> $(TOPDIR)/feeds/packages/lang/rust)
            if grep -q "\.\./\.\./lang/rust/rust-package.mk" "$makefile"; then
                echo "Fixing Rust path in: $makefile"
                sed -i 's|\.\./\.\./lang/rust/rust-package.mk|$(TOPDIR)/feeds/packages/lang/rust/rust-package.mk|g' "$makefile"
            fi            
            
            # C. ä¿®å¤ LuCI è·¯å¾„ (../../luci.mk -> $(TOPDIR)/feeds/luci/luci.mk)
            if grep -q "\.\./\.\./luci.mk" "$makefile"; then
                echo "Fixing LuCI path in: $makefile"
                sed -i 's|\.\./\.\./luci.mk|$(TOPDIR)/feeds/luci/luci.mk|g' "$makefile"
            fi
        done

        # â¬‡ï¸ 4. é€‰ä¸­ä¸‹è½½çš„æ’ä»¶ auto_packages
        echo "Scanning for packages to select...auto_packages"
        find openwrt/package/custom_repos -name Makefile | while read makefile; do
            # æå–ç›®å½•å (å…œåº•ç­–ç•¥)
            pkg_dirname=$(basename "$(dirname "$makefile")")
            # æ ‡è®°æ‰“ç‚¹
            is_identified=false
            # é¢„å…ˆæå– PKG_NAME (å¤‡ç”¨)
            val_pkg_name=$(grep -E "^PKG_NAME:=" "$makefile" | awk -F':=' '{print $2}' | tr -d '[:space:]')
          
            # ğŸ¯ ä¼˜å…ˆå¤„ç† define Package/ (å‡†ç¡®åº¦æœ€é«˜ï¼Œå› ä¸ºä¸€æºå¤šåŒ…)
            objs=$(grep -E "^define Package/[^/]+[[:space:]]*$" "$makefile" | sed -E 's/^define Package\///' | sed -E 's/[[:space:]]*$//')
            
            for pkg in $objs; do
                # æƒ…å†µ A: å®šä¹‰ä½¿ç”¨äº†å˜é‡ $(PKG_NAME)ï¼Œä¸”æˆ‘ä»¬æå–åˆ°äº†å˜é‡å€¼ -> ä½¿ç”¨å˜é‡å€¼
                if [[ "$pkg" == *"\$(PKG_NAME)"* ]]; then
                    if [ -n "$val_pkg_name" ]; then
                        echo "CONFIG_PACKAGE_$val_pkg_name=y" >> auto_packages.txt
                        echo "  ğŸ”¹ [Define+Var] $val_pkg_name"
                        is_identified=true
                    fi
                # æƒ…å†µ B: æ™®é€šå®šä¹‰ï¼Œæ’é™¤å…¶ä»–å˜é‡å†™æ³• $(...) -> ç›´æ¥ä½¿ç”¨
                elif [[ "$pkg" != *"\$("* ]]; then
                    echo "CONFIG_PACKAGE_$pkg=y" >> auto_packages.txt
                    echo "  âœ… [Define Match] $pkg"
                    is_identified=true
                fi
            done

            # ğŸ“˜ å¦‚æœæ²¡æ‰¾åˆ° defineï¼Œå°è¯•ä½¿ç”¨ PKG_NAME
            if [ "$is_identified" == "false" ] && [ -n "$val_pkg_name" ]; then
                # æ’é™¤åµŒå¥—å˜é‡çš„æƒ…å†µ
                if [[ "$val_pkg_name" != *"\$("* ]]; then
                    echo "CONFIG_PACKAGE_$val_pkg_name=y" >> auto_packages.txt
                    echo "  ğŸ’¡ [LuCI/Simple] $val_pkg_name (from PKG_NAME)"
                    is_identified=true
                fi
            fi

            # âš ï¸ å®åœ¨æ‰¾ä¸åˆ°ï¼Œä½¿ç”¨ç›®å½•åå…œåº• (luciå¸¸è§)
            if [ "$is_identified" == "false" ]; then
                if [ "$pkg_dirname" != "src" ] && [ "$pkg_dirname" != "files" ]; then
                    echo "CONFIG_PACKAGE_$pkg_dirname=y" >> auto_packages.txt
                    echo "  ğŸ“‚ [Fallback] Directory: $pkg_dirname"
                fi
            fi
        done
        
        # ğŸ§¹ æœ€ç»ˆå»é‡
        sort -u auto_packages.txt -o auto_packages.txt
        
        # ğŸ”´ 5. å¤„ç† custom.config (æ”¯æŒ # CONFIG... is not set)
        CUSTOM_CONFIG_PATH="$GITHUB_WORKSPACE/custom.config"

        if [ -f "$CUSTOM_CONFIG_PATH" ]; then
          echo "Processing custom.config..."
          while IFS= read -r line || [ -n "$line" ]; do
            # å»é™¤é¦–å°¾ç©ºæ ¼
            line=$(echo "$line" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
            
            # è·³è¿‡ç©ºè¡Œ
            if [[ -z "$line" ]]; then continue; fi
            
            # !!!ä¼˜å…ˆå¤„ç† "is not set" çš„æ ‡å‡†ç¦ç”¨æ ¼å¼
            # ä½¿ç”¨æ­£åˆ™åŒ¹é…ï¼šä»¥ "# CONFIG_" å¼€å¤´ï¼Œä»¥ "is not set" ç»“å°¾
            if [[ "$line" =~ ^#\ CONFIG_.*\ is\ not\ set$ ]]; then
                echo "$line" >> auto_packages.txt
                echo "  [Explicit Disable]: $line"
                continue
            fi
            
            # è·³è¿‡æ™®é€šæ³¨é‡Š (ä»¥ # å¼€å¤´çš„å…¶ä»–å†…å®¹)
            if [[ "$line" == \#* ]]; then continue; fi
            
            # å¤„ç†å…¶ä»–æƒ…å†µ
            if [[ "$line" == CONFIG_* ]]; then
                # a. æ ‡å‡†å¼€å¯ (CONFIG_xxx=y)
                echo "$line" >> auto_packages.txt
                echo "  [Config Enable]: $line"
                # b. ç®€å†™ç¦ç”¨ (-åŒ…å) -> è‡ªåŠ¨è½¬ä¸º is not set
            elif [[ "$line" == -* ]]; then
                pkg_name=${line:1}
                echo "# CONFIG_PACKAGE_$pkg_name is not set" >> auto_packages.txt
                echo "  [Package Disable]: $pkg_name"
                # c. ç®€å†™å¼€å¯ (åŒ…å) -> è‡ªåŠ¨è½¬ä¸º =y
            else
                echo "CONFIG_PACKAGE_$line=y" >> auto_packages.txt
                echo "  [Package Enable]: $line"
            fi
          done < "$CUSTOM_CONFIG_PATH"
        else
          echo "custom.config not found, skipping."
        fi
        
        # ğŸ“‚ 6. å¤„ç† files ç›®å½• (ç›®å½•ä¸‹å†…å®¹é›†æˆè¿›å›ºä»¶1æ¯”1è¦†ç›–ï¼ŒåŒimagebuilderç”¨æ³•)
        if [ -d "$GITHUB_WORKSPACE/$CUSTOM_FILES_DIR" ]; then
          echo "Copying custom files..."
          cp -r $GITHUB_WORKSPACE/$CUSTOM_FILES_DIR openwrt/files
          chmod -R +x openwrt/files/* || true
        fi
        
        # ğŸ§© 7. åŠ è½½é…ç½®æ–‡ä»¶ (ä»ä»“åº“config/ ç›®å½•)
        if [ -e "$GITHUB_WORKSPACE/$CONFIG_FILE" ]; then
            echo "Using config file: $CONFIG_FILE"
            cp "$GITHUB_WORKSPACE/$CONFIG_FILE" openwrt/.config
        else
            echo "::error::Config file $CONFIG_FILE not found!"
            exit 1
        fi
        
        cd openwrt
        # âœ… ä¿®å¤ Go è·¯å¾„
        sed -i '/CONFIG_GOLANG_EXTERNAL_BOOTSTRAP_ROOT/d' .config    
        # âœ… é€‰ä¸­æ’ä»¶ï¼Œå‰é¢å¤„ç†custom.configå¾—åˆ°auto_packagesï¼Œå…ˆå»é‡å†è¿½åŠ 
        sort -u ../auto_packages.txt -o ../auto_packages.txt || true 
        echo "  âš™ï¸ Auto-selecting custom in .config..."
        cat ../auto_packages.txt >> .config
        #  æ‰“å°å‡ºæ¥çœ‹çœ‹é€‰ä¸­äº†å•¥
        cat ../auto_packages.txt
        
        # ğŸ”´ ç”Ÿæˆæœ€ç»ˆé…ç½®
        make defconfig

    - name: Download Libraries
      working-directory: ./openwrt
      run: |
        make download -j8
        find dl -size -1024c -exec rm -f {} \;

    - name: Compile OpenWrt
      working-directory: ./openwrt
      id: compile
      run: |
        echo -e "$(nproc) thread compile"
        df -hT
        # ä¼˜å…ˆå¤šçº¿ç¨‹ï¼Œå¤±è´¥è‡ªåŠ¨è½¬å•çº¿ç¨‹è°ƒè¯•
        make -j$(nproc) || make -j1 V=s || find staging_dir/ -name *.bin
        find staging_dir/ -name *.bin
        find staging_dir/ -name *.img
        find staging_dir/ -name *r4s*
        find staging_dir/ -name *rockchip*
        echo "status=success" >> $GITHUB_OUTPUT
        df -hT        

    - name: Organize Files
      id: organize
      if: steps.compile.outputs.status == 'success'
      run: |
        cd openwrt/bin
        ls -lhR
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: Upload Firmware
      uses: actions/upload-artifact@v4
      if: steps.organize.outputs.status == 'success'
      with:
        name: OpenWrt_Firmware_${{ inputs.config_file }}
        path: ${{ env.FIRMWARE }}
        retention-days: 3
